<html><head>
<script type='text/javascript'>window.mod_pagespeed_start = Number(new Date());</script><script src="JSARToolKit.js"></script>
<script src="magi.js"></script>
<script src="utils.js"></script>
<script src="http://1-ps.googleusercontent.com/x/s.html5rocks-hrd.appspot.com/www.html5rocks.com/en/tutorials/webgl/jsartoolkit_webrtc/photos.js.pagespeed.jm.5APXXL9PLR.js"></script>
<script>threshold=128;DEBUG=false;photos=Photos.map(Image.load);var video=document.createElement('video');video.width=640;video.height=480;video.loop=true;video.volume=0;video.autoplay=true;video.style.display='none';video.controls=true;var getUserMedia=function(t,onsuccess,onerror){if(navigator.getUserMedia){return navigator.getUserMedia(t,onsuccess,onerror);}else if(navigator.webkitGetUserMedia){return navigator.webkitGetUserMedia(t,onsuccess,onerror);}else if(navigator.mozGetUserMedia){return navigator.mozGetUserMedia(t,onsuccess,onerror);}else if(navigator.msGetUserMedia){return navigator.msGetUserMedia(t,onsuccess,onerror);}else{onerror(new Error("No getUserMedia implementation found."));}};var URL=window.URL||window.webkitURL;var createObjectURL=URL.createObjectURL||webkitURL.createObjectURL;if(!createObjectURL){throw new Error("URL.createObjectURL not found.");}
getUserMedia({'video':true},function(stream){var url=createObjectURL(stream);video.src=url;},function(error){alert("Couldn't access webcam.");});window.onload=function(){byId('loading').style.display='none';document.body.appendChild(video);var canvas=document.createElement('canvas');canvas.width=320;canvas.height=240;canvas.style.display='block';var videoCanvas=document.createElement('canvas');videoCanvas.width=video.width;videoCanvas.height=video.height;var raster=new NyARRgbRaster_Canvas2D(canvas);var param=new FLARParam(320,240);var resultMat=new NyARTransMatResult();var detector=new FLARMultiIdMarkerDetector(param,120);detector.setContinueMode(true);var ctx=canvas.getContext('2d');ctx.font="24px URW Gothic L, Arial, Sans-serif";var glCanvas=document.createElement('canvas');glCanvas.style.webkitTransform='scale(-1.0, 1.0)';glCanvas.width=960;glCanvas.height=720;var s=glCanvas.style;document.body.appendChild(glCanvas);display=new Magi.Scene(glCanvas);display.drawOnlyWhenChanged=true;param.copyCameraMatrix(display.camera.perspectiveMatrix,10,10000);display.camera.useProjectionMatrix=true;var videoTex=new Magi.FlipFilterQuad();videoTex.material.textures.Texture0=new Magi.Texture();videoTex.material.textures.Texture0.image=videoCanvas;videoTex.material.textures.Texture0.generateMipmaps=false;display.scene.appendChild(videoTex);var times=[];var pastResults={};var lastTime=0;var cubes={};var images=[];window.updateImage=function(){display.changed=true;}
window.addEventListener('keydown',function(ev){if(Key.match(ev,Key.LEFT)){images.forEach(function(e){e.setImage(photos.rotate(true));});}else if(Key.match(ev,Key.RIGHT)){images.forEach(function(e){e.setImage(photos.rotate(false));});}},false);setInterval(function(){if(video.ended)video.play();if(video.paused)return;if(window.paused)return;if(video.currentTime==video.duration){video.currentTime=0;}
if(video.currentTime==lastTime)return;lastTime=video.currentTime;videoCanvas.getContext('2d').drawImage(video,0,0);ctx.drawImage(videoCanvas,0,0,320,240);var dt=new Date().getTime();videoTex.material.textures.Texture0.changed=true;canvas.changed=true;display.changed=true;var t=new Date();var detected=detector.detectMarkerLite(raster,threshold);for(var idx=0;idx<detected;idx++){var id=detector.getIdMarkerData(idx);var currId;if(id.packetLength>4){currId=-1;}else{currId=0;for(var i=0;i<id.packetLength;i++){currId=(currId<<8)|id.getPacketData(i);}}
if(!pastResults[currId]){pastResults[currId]={};}
detector.getTransformMatrix(idx,resultMat);pastResults[currId].age=0;pastResults[currId].transform=Object.asCopy(resultMat);}
for(var i in pastResults){var r=pastResults[i];if(r.age>1){delete pastResults[i];cubes[i].image.setImage(photos.rotate());}
r.age++;}
for(var i in cubes)cubes[i].display=false;for(var i in pastResults){if(!cubes[i]){var pivot=new Magi.Node();pivot.transform=mat4.identity();pivot.setScale(80);var image=new Magi.Image();image.setAlign(image.centerAlign,image.centerAlign).setPosition(0,0,0).setAxis(0,0,1).setAngle(Math.PI).setSize(1.5);image.setImage=function(src){var img=E.canvas(640,640);Magi.Image.setImage.call(this,img);this.texture.generateMipmaps=false;var self=this;src.onload=function(){var w=this.width,h=this.height;var f=Math.min(640/w,640/h);w=(w*f);h=(h*f);img.getContext('2d').drawImage(this,(640-w)/2,(640-h)/2,w,h);self.texture.changed=true;self.setSize(1.1*Math.max(w/h,h/w));};if(Object.isImageLoaded(src)){src.onload();}};image.setImage(photos.rotate());images.push(image);pivot.image=image;pivot.appendChild(image);display.scene.appendChild(pivot);cubes[i]=pivot;}
cubes[i].display=true;var mat=pastResults[i].transform;var cm=cubes[i].transform;cm[0]=mat.m00;cm[1]=-mat.m10;cm[2]=mat.m20;cm[3]=0;cm[4]=mat.m01;cm[5]=-mat.m11;cm[6]=mat.m21;cm[7]=0;cm[8]=-mat.m02;cm[9]=mat.m12;cm[10]=-mat.m22;cm[11]=0;cm[12]=mat.m03;cm[13]=-mat.m13;cm[14]=mat.m23;cm[15]=1;}},15);}</script>
<style>html{background:#000;color:#fff}body{margin:0;padding:0;margin-top:20px;text-align:center}#loading{font-size:80px;font-weight:bold;font-family:Times}</style>
<link rel="dns-prefetch" href="//1-ps.googleusercontent.com"></head>
<body><noscript><meta HTTP-EQUIV="refresh" content="0;url='http://www.html5rocks.com/en/tutorials/webgl/jsartoolkit_webrtc/AR_mediaStream.html?ModPagespeed=noscript'" /><style><!--table,div,span,font,p{display:none} --></style><div style="display:block">Please click <a href="http://www.html5rocks.com/en/tutorials/webgl/jsartoolkit_webrtc/AR_mediaStream.html?ModPagespeed=noscript">here</a> if you are not redirected within a few seconds.</div></noscript>
<div id="loading">Hang on, I'm loading stuff...</div>
<script type="text/javascript">var _gaq=_gaq||[];_gaq.push(['_setAccount','UA-1485935-6']);_gaq.push(['_trackPageview']);(function(){var ga=document.createElement('script');ga.type='text/javascript';ga.async=true;ga.src=('https:'==document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ga,s);})();</script>
<script pagespeed_no_defer="" type="text/javascript">(function(){var e=window,f=Math,g="round",h="",q="&abt=",x="&act=",y="&adt=",z="&afd=",A="&attfb=",B="&mfd=",C="&nbt=",D="&nct=",E="&ndt=",F="&nfd=",G="&nttfb=",H="&rit_css=",I="&rit_img=",J="&rit_link=",K="&rit_script=";e.pagespeed=e.pagespeed||{};var L=e.pagespeed;
L.getResourceTimingData=function(){if(e.performance&&e.performance.webkitGetEntries){for(var r=0,s=0,k=0,t=0,l=0,u=0,m=0,v=0,n=0,w=0,p=0,c={},d=e.performance.webkitGetEntries(),b=0;b<d.length;b++){var a=d[b].duration;0<a&&(r+=a,++k,s=f.max(s,a));a=d[b].connectEnd-d[b].connectStart;0<a&&(u+=a,++m);a=d[b].domainLookupEnd-d[b].domainLookupStart;0<a&&(t+=a,++l);a=d[b].initiatorType;c[a]?++c[a]:c[a]=1;a=d[b].requestStart-d[b].fetchStart;0<a&&(w+=a,++p);a=d[b].responseStart-d[b].requestStart;0<a&&(v+=a,
++n)}return z+(k?f[g](r/k):0)+F+k+B+f[g](s)+x+(m?f[g](u/m):0)+D+m+y+(l?f[g](t/l):0)+E+l+q+(p?f[g](w/p):0)+C+p+A+(n?f[g](v/n):0)+G+n+(c.css?H+c.css:h)+(c.link?J+c.link:h)+(c.script?K+c.script:h)+(c.img?I+c.img:h)}return h};L.getResourceTimingData=L.getResourceTimingData;})();
(function(){var c=encodeURIComponent,f=window,h="performance",k="",l="&",m="&b_csi=",n="&bci=",p="&cces=",r="&ccis=",s="&ccos=",t="&ccrl=",u="&ccul=",v="&connect=",w="&dns=",x="&dom_c=",y="&dwld=",z="&fp=",A="&htmlAt=",B="&ifr=0",C="&ifr=1",D="&nav=",E="&nrp=",F="&nt=",G="&r",H="&ref=",I="&req_start=",J="&ttfb=",K="&url=",L="=",M="?",N="EventStart",O="beforeunload",P="ets=",Q="load",R="load:",S="on",T="unload:";f.pagespeed=f.pagespeed||{};
var U=f.pagespeed,V=function(a,d,b,e,g){this.e=a;this.a=d;this.b=b;this.f=g;this.c=e};U.beaconUrl=k;
V.prototype.d=function(){var a=this.e,d=f.mod_pagespeed_start,b=Number(new Date)-d,a=a+(-1==a.indexOf(M)?M:l),a=a+P+(this.a==Q?R:T),a=a+b;if(this.a!=O||!f.mod_pagespeed_loaded){a+=G+this.a+L;if(f[h]){var b=f[h].timing,e=b.navigationStart,g=b.requestStart,a=a+(b[this.a+N]-e),a=a+(D+(b.fetchStart-e)),a=a+(w+(b.domainLookupEnd-b.domainLookupStart)),a=a+(v+(b.connectEnd-b.connectStart)),a=a+(I+(g-e)),a=a+(J+(b.responseStart-g)),a=a+(y+(b.responseEnd-b.responseStart)),a=a+(x+(b.domContentLoadedEventStart-
e));f[h].navigation&&(a+=F+f[h].navigation.type);e=-1;b.msFirstPaint?e=b.msFirstPaint:f.chrome&&f.chrome.loadTimes&&(e=Math.floor(1E3*f.chrome.loadTimes().firstPaintTime));-1!=e&&(a+=z+(e-g))}else a+=b;U.getResourceTimingData&&f.parent==f&&(a+=U.getResourceTimingData());a+=f.parent!=f?C:B;this.a==Q&&(f.mod_pagespeed_loaded=!0,(b=f.mod_pagespeed_num_resources_prefetched)&&(a+=E+b),(b=f.mod_pagespeed_prefetch_start)&&(a+=A+(d-b)));U.panelLoader&&(d=U.panelLoader.getCsiTimingsString(),d!=k&&(a+=m+d),
d=U.panelLoader.getCriticalImagesInfoString(),d!=k&&(a+=n+d));U.criticalCss&&(d=U.criticalCss,a+=r+d.total_critical_inlined_size+p+d.total_original_external_size+s+d.total_overhead_size+t+d.num_replaced_links+u+d.num_unreplaced_links);this.b!=k&&(a+=this.b);this.c!=k&&(a+=H+c(this.c));a+=K+c(this.f);U.beaconUrl=a;(new Image).src=a}};U.g=function(a,d,b,e,g){var q=new V(a,d,b,e,g);f.addEventListener?f.addEventListener(d,function(){q.d()},!1):f.attachEvent(S+d,function(){q.d()})};
U.addInstrumentationInit=U.g;})();

pagespeed.addInstrumentationInit('http://1-ps.googleusercontent.com/beacon?org=98_1_jt', 'load', '', '', 'http://www.html5rocks.com/en/tutorials/webgl/jsartoolkit_webrtc/AR_mediaStream.html');</script></body>
</html>
